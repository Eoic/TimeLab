<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>File Visibility Button Focus Retention Fix - TimeLab</title>
        <style>
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    sans-serif;
                line-height: 1.6;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
            }
            .section {
                background: white;
                padding: 20px;
                margin: 20px 0;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }
            .problem {
                background: #fff2f2;
                border-left: 4px solid #dc3545;
            }
            .solution {
                background: #f2fff2;
                border-left: 4px solid #28a745;
            }
            code {
                background: #f8f9fa;
                padding: 2px 6px;
                border-radius: 4px;
                font-family: 'Consolas', 'Monaco', monospace;
            }
            .code-block {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 6px;
                overflow-x: auto;
                margin: 10px 0;
            }
            .warning {
                color: #dc3545;
                font-weight: 600;
            }
            .success {
                color: #28a745;
                font-weight: 600;
            }
            .info {
                color: #0066cc;
                font-weight: 600;
            }
            ul {
                list-style-type: none;
                padding-left: 0;
            }
            ul li:before {
                content: 'âœ… ';
                margin-right: 8px;
            }
        </style>
    </head>
    <body>
        <h1>ðŸŽ¯ File Visibility Button Focus Retention Fix</h1>

        <div class="section problem">
            <h2>Problem: Lost Focus on Visibility Toggle</h2>
            <p>
                <strong>Issue:</strong> When clicking the "Visible"/"Hidden" button in the "Manage
                data files" modal, focus was removed from the button after the action completed.
            </p>

            <p>
                <strong>Root Cause:</strong> The visibility toggle triggered a complete DOM
                re-render of the file list (<code>renderFilesList()</code>), which destroyed and
                recreated all file item elements, including the button that had focus.
            </p>

            <div class="code-block warning">
                User Experience Impact: â€¢ Keyboard navigation was interrupted â€¢ Users lost their
                place in the file list â€¢ Required refocusing manually for continued keyboard
                interaction
            </div>
        </div>

        <div class="section solution">
            <h2>Solution: Focus Restoration After DOM Re-render</h2>
            <p>
                <strong>Strategy:</strong> Modified <code>renderFilesList</code> to accept an
                optional <code>focusFileId</code> parameter and restore focus to the corresponding
                button after the DOM is recreated.
            </p>

            <h3>Implementation Details</h3>
            <div class="code-block">
                <pre>
// Updated function signature
const renderFilesList = (focusFileId?: string) => {
    // ... DOM creation logic ...
    
    for (const file of dataFiles) {
        // ... create file item elements ...
        
        const vis = document.createElement('button');
        // ... button setup ...
        
        vis.addEventListener('click', () => {
            file.visible = !file.visible;
            
            // Save and re-render with focus restoration
            await saveRecord(file);
            renderFilesList(file.id); // Pass file ID for focus restoration
            notifyChange();
        });
        
        // Restore focus if this is the target button
        if (focusFileId === file.id) {
            requestAnimationFrame(() => {
                vis.focus();
            });
        }
        
        // ... append to DOM ...
    }
};</pre
                >
            </div>

            <h3>Key Features</h3>
            <ul>
                <li>Optional parameter allows normal rendering without focus changes</li>
                <li>Uses <code>requestAnimationFrame</code> for proper timing</li>
                <li>Identifies target button by file ID for accuracy</li>
                <li>Maintains existing functionality while adding focus retention</li>
            </ul>
        </div>

        <div class="section">
            <h2>Technical Implementation</h2>

            <h3>File Modified</h3>
            <p><code>src/uploads/index.ts</code> - Updated <code>renderFilesList</code> function</p>

            <h3>Changes Made</h3>
            <ol style="list-style-type: decimal; padding-left: 20px">
                <li>
                    <strong>Function Signature:</strong> Added optional
                    <code>focusFileId?: string</code> parameter
                </li>
                <li>
                    <strong>Click Handler:</strong> Modified to pass <code>file.id</code> when
                    calling <code>renderFilesList</code>
                </li>
                <li>
                    <strong>Focus Restoration:</strong> Added conditional focus logic using
                    <code>requestAnimationFrame</code>
                </li>
            </ol>

            <h3>Timing Considerations</h3>
            <p>The <code>requestAnimationFrame</code> ensures that:</p>
            <ul>
                <li>DOM is fully rendered before attempting to focus</li>
                <li>Browser layout calculations are complete</li>
                <li>Focus change happens in the next frame for smooth UX</li>
            </ul>
        </div>

        <div class="section">
            <h2>Benefits</h2>
            <ul>
                <li>
                    <strong>Improved Keyboard Navigation:</strong> Users can toggle multiple files
                    without losing their place
                </li>
                <li><strong>Better Accessibility:</strong> Screen reader users maintain context</li>
                <li><strong>Enhanced UX:</strong> No need to manually refocus after each action</li>
                <li>
                    <strong>Minimal Code Impact:</strong> Backwards compatible, no breaking changes
                </li>
                <li>
                    <strong>Robust Implementation:</strong> Uses file ID matching for reliability
                </li>
            </ul>
        </div>

        <div class="section">
            <h2>Usage Scenarios</h2>

            <h3>Before Fix</h3>
            <div class="code-block warning">
                1. User opens "Manage data files" modal 2. User navigates to a visibility button
                with keyboard (Tab) 3. User presses Enter/Space to toggle visibility 4. ðŸš« Focus is
                lost, user must Tab again to continue
            </div>

            <h3>After Fix</h3>
            <div class="code-block success">
                1. User opens "Manage data files" modal 2. User navigates to a visibility button
                with keyboard (Tab) 3. User presses Enter/Space to toggle visibility 4. âœ… Focus
                remains on the same button, ready for next action
            </div>
        </div>

        <div class="section success">
            <h2>âœ… Resolution Complete</h2>
            <p class="success">
                The file visibility button focus retention issue has been resolved. Users can now
                toggle file visibility without losing keyboard focus, providing a much smoother
                experience for keyboard navigation and accessibility.
            </p>

            <p>
                <strong>Test the fix:</strong> Open the "Manage data files" modal, use Tab to
                navigate to a visibility button, and press Enter to toggle. Focus should remain on
                the button for seamless continued interaction.
            </p>
        </div>
    </body>
</html>
