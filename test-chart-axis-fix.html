<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chart Axis Configuration Fix Test</title>
        <style>
            body {
                font-family:
                    system-ui,
                    -apple-system,
                    sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                line-height: 1.6;
            }

            .test-section {
                background: #f5f5f5;
                padding: 20px;
                margin: 20px 0;
                border-radius: 8px;
            }

            .issue-description {
                background: #fee;
                border: 1px solid #fcc;
                padding: 15px;
                border-radius: 4px;
                margin: 15px 0;
            }

            .fix-description {
                background: #efe;
                border: 1px solid #cfc;
                padding: 15px;
                border-radius: 4px;
                margin: 15px 0;
            }

            code {
                background: #e8e8e8;
                padding: 2px 6px;
                border-radius: 3px;
                font-family: 'Monaco', 'Consolas', monospace;
            }

            pre {
                background: #f8f8f8;
                padding: 15px;
                border-radius: 4px;
                overflow-x: auto;
                font-size: 14px;
            }
        </style>
    </head>
    <body>
        <h1>üîß Chart Axis Configuration Fix</h1>

        <div class="test-section">
            <h2>üìã Issue Summary</h2>
            <p>The Chart Configuration panel's X-axis selection had several critical bugs:</p>

            <div class="issue-description">
                <h3>üêõ Problems Identified:</h3>
                <ol>
                    <li>
                        <strong>Index Selection Failed:</strong> Switching x-axis to "index"
                        rendered nothing on the chart
                    </li>
                    <li>
                        <strong>Column Mix-up:</strong> Switching x-axis to "press_force_kN" or
                        "piezo_strain_microstrain" always rendered as if x-axis was "press_force_kN"
                    </li>
                    <li>
                        <strong>Mapping Mismatch:</strong> Dropdown values didn't map properly to
                        ECharts axis types
                    </li>
                    <li>
                        <strong>Data Processing Bug:</strong> The "index" special case wasn't
                        handled in getData() method
                    </li>
                </ol>
            </div>
        </div>

        <div class="test-section">
            <h2>üîç Root Cause Analysis</h2>

            <h3>1. Index Handling in getData() Method</h3>
            <pre><code>// BEFORE (BROKEN):
getData(xColumn: string, yColumn: string): ReadonlyArray&lt;readonly [number, number]&gt; {
    const xIndex = this.columns.indexOf(xColumn); // ‚ùå "index" returns -1
    const yIndex = this.columns.indexOf(yColumn);
    
    if (xIndex === -1 || yIndex === -1) {
        return []; // ‚ùå Always empty for "index"
    }
    // ...
}

// AFTER (FIXED):
getData(xColumn: string, yColumn: string): ReadonlyArray&lt;readonly [number, number]&gt; {
    // Handle special case for "index" - use row index instead of column data
    const useXIndex = xColumn === 'index';
    const useYIndex = yColumn === 'index';
    
    const xIndex = useXIndex ? -1 : this.columns.indexOf(xColumn);
    const yIndex = useYIndex ? -1 : this.columns.indexOf(yColumn);
    
    // Check if non-index columns exist
    if (!useXIndex && xIndex === -1) return [];
    if (!useYIndex && yIndex === -1) return [];
    
    return this.parsedData.map((row, index) =&gt; {
        const xValue = useXIndex ? index : /* column data */;
        const yValue = useYIndex ? index : /* column data */;
        return [xValue, yValue] as const;
    });
}</code></pre>

            <h3>2. X-Axis Type Mapping Disconnect</h3>
            <pre><code>// DROPDOWN OPTIONS (in dropdowns.ts):
cfgXType.options = [
    { value: 'index', label: 'Index (category)' },
    { value: 'time', label: 'Time (date/time)' },
    { value: 'numeric', label: 'Numeric (value axis)' }
];

// BEFORE (BROKEN MAPPING):
const xType: 'category' | 'time' | 'value' =
    xTypeValue && ['category', 'time', 'value'].includes(xTypeValue)
        ? (xTypeValue as 'category' | 'time' | 'value')
        : 'category'; // ‚ùå 'index' and 'numeric' values never match!

// AFTER (FIXED MAPPING):
const xType: 'category' | 'time' | 'value' = (() => {
    switch (xTypeValue) {
        case 'time': return 'time';
        case 'numeric': return 'value';
        case 'index':
        default: return 'category';
    }
})();</code></pre>
        </div>

        <div class="test-section">
            <h2>‚úÖ Fixes Applied</h2>

            <div class="fix-description">
                <h3>üõ†Ô∏è File: src/data/csvProcessor.ts</h3>
                <ul>
                    <li>‚úÖ Added special handling for "index" in getData() method</li>
                    <li>
                        ‚úÖ "index" selection now uses row indices (0, 1, 2, ...) instead of column
                        lookup
                    </li>
                    <li>‚úÖ Proper validation for index vs column data access</li>
                    <li>‚úÖ Support for both X and Y axes using "index" if needed</li>
                </ul>
            </div>

            <div class="fix-description">
                <h3>üõ†Ô∏è File: src/charts/timeSeries.ts</h3>
                <ul>
                    <li>‚úÖ Fixed X-axis type mapping in getCurrentChartConfig()</li>
                    <li>‚úÖ 'index' ‚Üí 'category' mapping</li>
                    <li>‚úÖ 'numeric' ‚Üí 'value' mapping</li>
                    <li>‚úÖ 'time' ‚Üí 'time' mapping (unchanged)</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <h2>üß™ Test Scenarios</h2>
            <p>To verify the fix works, test these scenarios in the main application:</p>

            <ol>
                <li>
                    <strong>Index X-Axis Test:</strong>
                    <ul>
                        <li>Load CSV data with the example file</li>
                        <li>
                            Set X-axis to "index" and Y-axis to any data column (e.g., "Total press
                            force")
                        </li>
                        <li>
                            ‚úÖ Expected: Chart should render with sequential indices (0, 1, 2, ...)
                            on X-axis
                        </li>
                    </ul>
                </li>

                <li>
                    <strong>Column Selection Test:</strong>
                    <ul>
                        <li>
                            Set X-axis to "press_force_kN" and Y-axis to "piezo_strain_microstrain"
                        </li>
                        <li>
                            ‚úÖ Expected: Chart should render correctly with press_force_kN data on
                            X-axis
                        </li>
                        <li>
                            Then switch X-axis to "piezo_strain_microstrain" and Y-axis to
                            "press_force_kN"
                        </li>
                        <li>
                            ‚úÖ Expected: Chart should show different data distribution (axes
                            swapped)
                        </li>
                    </ul>
                </li>

                <li>
                    <strong>X-Axis Type Configuration:</strong>
                    <ul>
                        <li>Test "Index (category)" - should work with any column data</li>
                        <li>Test "Time (date/time)" - should work with time-like columns</li>
                        <li>Test "Numeric (value axis)" - should work with numeric columns</li>
                        <li>
                            ‚úÖ Expected: Each type should apply proper ECharts axis configuration
                        </li>
                    </ul>
                </li>
            </ol>
        </div>

        <div class="test-section">
            <h2>üìä Expected Behavior</h2>

            <h3>Before Fix:</h3>
            <ul>
                <li>‚ùå X-axis "index" ‚Üí Empty chart</li>
                <li>
                    ‚ùå X-axis "press_force_kN" vs "piezo_strain_microstrain" ‚Üí Same chart rendered
                </li>
                <li>‚ùå X-axis type changes had no visible effect</li>
            </ul>

            <h3>After Fix:</h3>
            <ul>
                <li>‚úÖ X-axis "index" ‚Üí Chart with row indices (0, 1, 2, ...)</li>
                <li>‚úÖ X-axis "press_force_kN" vs "piezo_strain_microstrain" ‚Üí Different charts</li>
                <li>‚úÖ X-axis type changes properly affect chart rendering</li>
                <li>‚úÖ All axis combinations work as expected</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>üîó Technical Details</h2>

            <h3>ECharts Axis Types:</h3>
            <ul>
                <li><code>category</code>: Discrete categories (perfect for index 0, 1, 2, ...)</li>
                <li><code>time</code>: Continuous time series</li>
                <li><code>value</code>: Continuous numeric values</li>
            </ul>

            <h3>Special "index" Handling:</h3>
            <p>
                When "index" is selected as X or Y axis, the system now generates synthetic index
                values (0, 1, 2, ...) instead of trying to find a column named "index" in the CSV
                data.
            </p>

            <h3>Data Flow:</h3>
            <pre><code>User selects axis ‚Üí Dropdown value ‚Üí getCurrentChartConfig() ‚Üí 
Proper type mapping ‚Üí updateDisplay() ‚Üí getData() with special index handling ‚Üí 
ECharts rendering with correct data</code></pre>
        </div>

        <p>
            <strong>üéØ Status:</strong> Chart axis configuration bugs are now fixed and should work
            correctly!
        </p>
    </body>
</html>
